services:
  mysql-test:
    image: mysql:8.0
    # container_name/hostname ì—†ìŒ: ì„œë¹„ìŠ¤ëª… DNSë¡œ ì ‘ê·¼ (CI ì´ë¦„ì¶©ëŒ ë°©ì§€)
    ports:
      - "3307:3306" # ë¡œì»¬ì—ì„œ ì ‘ì†ìš©; CI ë‚´ë¶€í†µì‹ ì—ëŠ” ë¶ˆí•„ìš”í•˜ì§€ë§Œ ìœ ì§€í•´ë„ ë¬´ë°©
    environment:
      MYSQL_ROOT_PASSWORD: root
      MYSQL_DATABASE: gear4camp_test
    command: ["--innodb-buffer-pool-size=64M", "--max_connections=50"] # 137ì—ëŸ¬ë¡œ ì¸í•œ ë©”ëª¨ë¦¬ ì ˆê°
    healthcheck:
      test: [ "CMD", "mysqladmin", "ping", "-h", "127.0.0.1", "-u", "root", "-proot", "--protocol=TCP" ]
      interval: 10s
      timeout: 5s
      retries: 30
    networks:
      - test-network

  app-test:
    build:
      context: .  # Dockerfileì´ ìˆëŠ” ê²½ë¡œ
#    container_name: spring-app-test -> ì„œë¹„ìŠ¤ëª… ì‚¬ìš©
    depends_on:
      mysql-test:
        condition: service_healthy
    command: ["tail", "-f", "/dev/null"]  # ì»¨í…Œì´ë„ˆ ì‚´ì•„ìˆê²Œ ìœ ì§€
      # ğŸ‘‡ OOM(137) ë°©ì§€: í…ŒìŠ¤íŠ¸ JVM/Gradle ìƒí•œ ê³ ì •
    environment:
        JAVA_TOOL_OPTIONS: "-Xmx512m -XX:MaxMetaspaceSize=256m"
        GRADLE_OPTS: "-Xmx512m -Dorg.gradle.jvmargs='-Xmx512m -XX:MaxMetaspaceSize=256m -Dfile.encoding=UTF-8'"
    networks:
      - test-network
#    CIì—ì„œëŠ” ëª…ë ¹ì¤„ë¡œ í”„ë¡œí•„ì„ ë„˜ê¸°ë¯€ë¡œ êµ³ì´ ë°•ì§€ ì•ŠìŒ
#    environment:
#      SPRING_PROFILES_ACTIVE: test-docker

networks:
  test-network:
    driver: bridge

# í…ŒìŠ¤íŠ¸ DBëŠ” ë§¤ë²ˆ ê¹¨ë—í•œ ìƒíƒœê°€ ì¢‹ìŒ
# ë³¼ë¥¨ì„ ì“°ë©´ ë”í‹° ë°ì´í„°ê°€ ë‚¨ì•„ í…ŒìŠ¤íŠ¸ê°€ í™˜ê²½ ì˜ì¡´ì ìœ¼ë¡œ ë³€í•˜ê¸°ì— ì˜ë„ì  ì œê±°
#volumes:
#  mysql_test_data:
