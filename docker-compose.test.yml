services:
  mysql-test:
    image: mysql:8.0
    # container_name/hostname 없음: 서비스명 DNS로 접근 (CI 이름충돌 방지)
    ports:
      - "3307:3306" # 로컬에서 접속용; CI 내부통신에는 불필요하지만 유지해도 무방
    environment:
      MYSQL_ROOT_PASSWORD: root
      MYSQL_DATABASE: gear4camp_test
    healthcheck:
      test: [ "CMD", "mysqladmin", "ping", "-h", "127.0.0.1", "-u", "root", "-proot", "--protocol=TCP" ]
      interval: 10s
      timeout: 5s
      retries: 30
    networks:
      - test-network

  app-test:
    build:
      context: .  # Dockerfile이 있는 경로
#    container_name: spring-app-test -> 서비스명 사용
    depends_on:
      mysql-test:
        condition: service_healthy
    command: ["tail", "-f", "/dev/null"]  # 컨테이너 살아있게 유지
    networks:
      - test-network
#    CI에서는 명령줄로 프로필을 넘기므로 굳이 박지 않음
#    environment:
#      SPRING_PROFILES_ACTIVE: test-docker

networks:
  test-network:
    driver: bridge

# 테스트 DB는 매번 깨끗한 상태가 좋음
# 볼륨을 쓰면 더티 데이터가 남아 테스트가 환경 의존적으로 변하기에 의도적 제거
#volumes:
#  mysql_test_data:
